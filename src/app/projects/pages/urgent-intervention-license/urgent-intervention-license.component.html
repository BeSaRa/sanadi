<div class="row">
  <tabs-list [accordionView]="accordionView" class="py-4" (onTabChange)="onTabChange($event)" [tabByIndex$]="tabIndex$">
    <tab [name]="tabsData.basicInfo.name" [hasError]="getTabInvalidStatus('basicInfo')"
         [template]="basicInfoTabTemplate" [title]="lang.map.lbl_basic_info"></tab>
    <tab [name]="tabsData.emergencyFunds.name" [hasError]="getTabInvalidStatus('emergencyFunds')"
         [template]="emergencyFundsTabTemplate" [title]="lang.map.emergency_funds_info"></tab>
    <tab [name]="tabsData.projectSummary.name" [hasError]="getTabInvalidStatus('projectSummary')"
         [template]="projectSummaryTabTemplate" [title]="lang.map.project_summary_info"></tab>
    <tab [name]="tabsData.specialExplanations.name" [hasError]="getTabInvalidStatus('specialExplanations')"
         [template]="specialExplanationsTabTemplate" [title]="lang.map.special_explanations"></tab>
    <tab *ngIf="!accordionView" [name]="tabsData.attachments.name" [hasError]="getTabInvalidStatus('attachments')"
         [template]="attachmentsTab" [title]="lang.map.attachments"></tab>
  </tabs-list>
</div>
<ng-container [formGroup]="form">
  <ng-template #basicInfoTabTemplate>
    <div formGroupName="basicInfo">
      <div class="row">
        <div class="col-sm-12 col-md-4 mb-4 position-relative">
          <label for="requestType" asteriskIfRequired="requestType"
                 class="form-label">{{lang.map.request_type}}</label>
          <ng-select [selectOnTab]="true" labelForId="requestType" [clearable]="true"
                     placeholder="{{lang.map.select}}" id="requestType"
                     (change)="handleRequestTypeChange($event, true)"
                     [notFoundText]="lang.map.msg_not_found"
                     [readonly]="!isEditRequestTypeAllowed()" appendTo="body"
                     formControlName="requestType" validationClasses="requestType">
            <ng-option *ngFor="let option of requestTypesList" [value]="option.lookupKey">
              {{option.getName()}}
            </ng-option>
          </ng-select>
          <app-field-error-message controlName="requestType"></app-field-error-message>
        </div>
        <div class="col-sm-12 col-md-4 mb-4 position-relative">
          <label for="oldLicenseFullSerial" asteriskIfRequired="oldLicenseFullSerial"
                 class="form-label">{{lang.map.license_number}}</label>
          <div class="input-group">
            <input (keydown.enter)="isEditLicenseAllowed() && licenseSearch($event)"
                   formControlName="oldLicenseFullSerial"
                   type="text" [readOnly]="!isEditLicenseAllowed()"
                   validationClasses="oldLicenseFullSerial" [onlyInvalid]="false" class="form-control"
                   id="oldLicenseFullSerial" trimInput>
            <button *ngIf="isEditLicenseAllowed()" type="button" (click)="licenseSearch($event)"
                    class="input-group-text"><i
              class="mdi {{fileIconsEnum.SEARCH}} text-primary"></i></button>
            <app-field-error-message controlName="oldLicenseFullSerial"></app-field-error-message>
          </div>
        </div>
        <div class="col-sm-12 col-md-4 mb-4 position-relative">
          <label for="year" asteriskIfRequired="year" class="form-label">{{lang.map.year}}</label>
          <input id="year" validationClasses="year" [readOnly]="(isExtendOrCancelRequestType() || readonly)"
                 formControlName="year" trimInput class="form-control" type="text" onlyNumbers maxlength="4">
          <app-field-error-message controlName="year"></app-field-error-message>
        </div>
      </div>
      <div *ngIf="selectedLicense">
        <app-table #table
                   [data]="[selectedLicense]"
                   [columns]="service.selectLicenseDisplayColumns">
          <table cdk-table [dataSource]="table.dataSource" class="table table-striped table-bordered caption-top">
            <ng-container cdkColumnDef="arName">
              <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.office_arabic_name}}</th>
              <td cdk-cell *cdkCellDef="let row"> {{row.arName}} </td>
            </ng-container>
            <ng-container cdkColumnDef="enName">
              <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.office_english_name}}</th>
              <td cdk-cell *cdkCellDef="let row"> {{row.enName}} </td>
            </ng-container>
            <ng-container cdkColumnDef="licenseNumber">
              <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.license_number}}</th>
              <td cdk-cell *cdkCellDef="let row"> {{row.fullSerial}} </td>
            </ng-container>
            <ng-container cdkColumnDef="fullSerial">
              <!-- full serial will be shown as License number, so label is license number -->
              <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.license_number}}</th>
              <td cdk-cell *cdkCellDef="let row"> {{row.fullSerial}} </td>
            </ng-container>
            <ng-container cdkColumnDef="status">
              <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.license_status}}</th>
              <td cdk-cell *cdkCellDef="let row"> {{row.licenseStatusInfo.getName()}} </td>
            </ng-container>
            <ng-container cdkColumnDef="endDate">
              <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.license_end_date}}</th>
              <td cdk-cell
                  *cdkCellDef="let row"> {{!row.licenseEndDate ? '' : row.licenseEndDate|date: 'mediumDate'}} </td>
            </ng-container>
            <ng-container cdkColumnDef="actions">
              <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.lbl_actions}}</th>
              <td cdk-cell *cdkCellDef="let row">
                <button class="btn btn-link outline-none mx-2"
                        tooltip="{{lang.map.view_license}}"
                        (click)="viewLicenseAsPDF(row)">
                  <i class="mdi {{fileIconsEnum.PDF}}"></i></button>
              </td>
            </ng-container>
            <tr *cdkNoDataRow>
              <td colspan="20" class="text-center">{{lang.map.no_records_to_display}}</td>
            </tr>
            <tr cdk-header-row *cdkHeaderRowDef="service.selectLicenseDisplayColumns"></tr>
            <tr cdk-row *cdkRowDef="let row; columns: service.selectLicenseDisplayColumns;"></tr>
          </table>
        </app-table>
      </div>
      <div class="row">
        <div class="col-sm-12 col-md-4 mb-4 position-relative">
          <label for="domain" asteriskIfRequired="domain" class="form-label">{{lang.map.domain}}</label>
          <span id="domain" class="form-control input-disabled"
                [innerHTML]="model && model.domainInfo && model.domainInfo.getName() || '&nbsp;'"></span>
        </div>
        <div class="col-md-4 col-sm-12 mb-4 position-relative">
          <label class="form-label" asteriskIfRequired="mainUNOCHACategory"
                 for="mainUNOCHACategory">{{lang.map.main_unocha_category}}</label>
          <span id="mainUNOCHACategory" class="form-control input-disabled"
                [innerHTML]="model && model.mainUNOCHAInfo && model.mainUNOCHAInfo.getName() || '&nbsp;'"></span>
        </div>
      </div>
    </div>
  </ng-template>
  <ng-template #emergencyFundsTabTemplate>
    <div formGroupName="emergencyFunds">
      <div class="row">
        <div class="col-sm-12 col-md-4 mb-4 position-relative">
          <label asteriskIfRequired="bankName" for="bankName" class="form-label">{{lang.map.bank_name}}</label>
          <input id="bankName" validationClasses="bankName" formControlName="bankName" trimInput class="form-control"
                 [readOnly]="(isExtendOrCancelRequestType() || readonly)">
          <app-field-error-message controlName="bankName"></app-field-error-message>
        </div>
        <div class="col-sm-12 col-md-4 mb-4 position-relative">
          <label asteriskIfRequired="accountNumber" for="accountNumber"
                 class="form-label">{{lang.map.account_number}}</label>
          <input id="accountNumber" validationClasses="accountNumber" formControlName="accountNumber" trimInput
                 class="form-control"
                 [readOnly]="(isExtendOrCancelRequestType() || readonly)">
          <app-field-error-message controlName="accountNumber"></app-field-error-message>
        </div>
        <div class="col-sm-12 col-md-4 mb-4 position-relative">
          <label asteriskIfRequired="iBan" for="iBan" class="form-label">{{lang.map.iban}}</label>
          <input id="iBan" validationClasses="iBan" formControlName="iBan" trimInput class="form-control"
                 [readOnly]="(isExtendOrCancelRequestType() || readonly)">
          <app-field-error-message controlName="iBan"></app-field-error-message>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-12 col-md-4 mb-4 position-relative">
          <label for="deductionPercent" asteriskIfRequired="deductionPercent"
                 class="form-label">{{lang.map.deduction_ratio}}</label>
          <div class="input-group">
            <input id="deductionPercent" validationClasses="deductionPercent"
                   [mask]="inputMaskPatterns.PERCENT"
                   [dropSpecialCharacters]="false"
                   [readOnly]="(isExtendOrCancelRequestType() || readonly)"
                   formControlName="deductionPercent" trimInput class="form-control" type="text">
            <div class="input-group-append">
              <span class="input-group-text">%</span>
            </div>
            <app-field-error-message controlName="deductionPercent"></app-field-error-message>
          </div>
        </div>
        <div class="col-sm-12 col-md-4 mb-4 position-relative">
          <label asteriskIfRequired="targetAmount" for="targetAmount"
                 class="form-label">{{lang.map.target_cost}}</label>
          <input id="targetAmount" validationClasses="targetAmount"
                 [readOnly]="(isExtendOrCancelRequestType() || readonly)"
                 formControlName="targetAmount" trimInput class="form-control" type="text">
          <app-field-error-message controlName="targetAmount"></app-field-error-message>
        </div>
        <div class="col-sm-12 col-md-4 mb-4 position-relative">
          <label asteriskIfRequired="currency" for="currency" class="form-label">{{lang.map.currency}}</label>
          <span id="currency" class="form-control input-disabled"
                [innerHTML]="model && model.currencyInfo && model.currencyInfo.getName() || '&nbsp;'"></span>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-12 col-md-4 mb-4 position-relative">
          <label for="licenseDuration" asteriskIfRequired="licenseDuration"
                 class="form-label">{{lang.map.license_duration}}</label>
          <span id="licenseDuration" class="form-control input-disabled"
                [innerHTML]="model && model.licenseDuration || '&nbsp;'"></span>
        </div>
      </div>
    </div>
  </ng-template>
  <ng-template #projectSummaryTabTemplate>
    <div formGroupName="projectSummary">
      <div class="row">
        <div class="col-sm-12 col-md-6 mb-4 position-relative">
          <label for="goals" asteriskIfRequired="goals" class="form-label">{{lang.map.project_goals}}</label>
          <textarea maxlength="1200" rows="2" id="goals" validationClasses="goals"
                    [readOnly]="(isExtendOrCancelRequestType() || readonly)"
                    formControlName="goals" trimInput class="form-control"></textarea>
          <app-field-error-message controlName="goals"></app-field-error-message>
        </div>
        <div class="col-sm-12 col-md-6 mb-4 position-relative">
          <label for="outputs" asteriskIfRequired="outputs" class="form-label">{{lang.map.project_outputs}}</label>
          <textarea maxlength="1200" rows="2" id="outputs" validationClasses="outputs"
                    [readOnly]="(isExtendOrCancelRequestType() || readonly)"
                    formControlName="outputs" trimInput class="form-control"></textarea>
          <app-field-error-message controlName="outputs"></app-field-error-message>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-12 col-md-6 mb-4 position-relative">
          <label for="successItems" asteriskIfRequired="successItems"
                 class="form-label">{{lang.map.project_success_items}}</label>
          <textarea maxlength="1200" rows="2" id="successItems" validationClasses="successItems"
                    [readOnly]="(isExtendOrCancelRequestType() || readonly)"
                    formControlName="successItems" trimInput class="form-control"></textarea>
          <app-field-error-message controlName="successItems"></app-field-error-message>
        </div>
        <div class="col-sm-12 col-md-6 mb-4 position-relative">
          <label for="expectedResults" asteriskIfRequired="expectedResults"
                 class="form-label">{{lang.map.project_expected_results}}</label>
          <textarea maxlength="1200" rows="2" id="expectedResults" validationClasses="expectedResults"
                    [readOnly]="(isExtendOrCancelRequestType() || readonly)"
                    formControlName="expectedResults" trimInput class="form-control"></textarea>
          <app-field-error-message controlName="expectedResults"></app-field-error-message>
        </div>
      </div>
    </div>
  </ng-template>
  <ng-template #specialExplanationsTabTemplate>
    <div class="row">
      <div class="col-sm-12 col-md-12 mb-4 position-relative">
        <label for="description" asteriskIfRequired="description"
               class="form-label">{{lang.map.special_explanations}}</label>
        <textarea maxlength="1200" rows="5" id="description" validationClasses="description"
                  [readOnly]="(readonly)"
                  formControlName="description" trimInput class="form-control"></textarea>
        <app-field-error-message controlName="description"></app-field-error-message>
      </div>
    </div>
  </ng-template>
  <ng-template #attachmentsTab>
    <attachments [disabled]="isAttachmentReadonly()" [caseId]="model?.id" [caseType]="model?.caseType"
                 [service]="service.documentService"
                 [load]="loadAttachments"></attachments>
  </ng-template>
</ng-container>
