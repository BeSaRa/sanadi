<div class="row">
  <div class="col-12 d-flex align-items-center">
    <h1 class="h6 text-primary m-0 d-inline-block">{{langService.map.menu_request_search}}</h1>
  </div>
</div>
<form autocomplete="off" [formGroup]="form">
  <div class="row mt-3">
    <tabs-list [tabByIndex$]="tabIndex$">
      <tab [template]="searchCriteria" [title]="langService.map.search_criteria"></tab>
      <tab [disabled]="!requests.length" [template]="searchResult" [title]="getResultTabTitle"></tab>
    </tabs-list>
  </div>
  <ng-template #searchCriteria>
    <div formGroupName="simpleSearch" id="simple-search">
      <div class="row">
        <div formGroupName="request" class="col-sm-12 col-md-6">
          <div class="row">
            <label for="requestSerial"
                   class="col-sm-12 col-md-4 col-form-label">{{langService.map.serial_number}}</label>
            <div class="col-md-8 col-sm-12 mb-4 position-relative">
              <input formControlName="requestSerial" id="requestSerial" type="text" class="form-control"
                     [ngClass]="fm.getInvalidClass('simpleSearch.request.requestSerial')">
              <app-field-error-message
                [control]="fm.getFormField('simpleSearch.request.requestSerial')"></app-field-error-message>
            </div>
          </div>
        </div>
        <div class="col-sm-12 col-md-6">
          <div class="row">
            <label for="year" class="col-sm-12 col-md-4 col-form-label">{{langService.map.year}}</label>
            <div class="col-md-8 col-sm-12 mb-4 ng-select-wrapper">
              <ng-select [selectOnTab]="true" labelForId="year" [clearable]="false"
                         placeholder="{{langService.map.select}}" id="year"
                         [notFoundText]="langService.map.msg_not_found"
                         formControlName="year">
                <ng-option *ngFor="let option of years" [value]="option">
                  {{option}}
                </ng-option>
              </ng-select>
            </div>
          </div>
        </div>
      </div>
      <div formGroupName="beneficiary">
        <div class="row">
          <div class="col-sm-12 col-md-6">
            <div class="row">
              <label for="benPrimaryIdType"
                     class="col-sm-12 col-md-4 col-form-label">{{langService.map.beneficiary_primary_id}}</label>
              <div class="col-md-8 col-sm-12 mb-4 ng-select-wrapper">
                <ng-select [selectOnTab]="true" labelForId="benPrimaryIdType" [clearable]="false"
                           placeholder="{{langService.map.select}}" id="benPrimaryIdType"
                           [notFoundText]="langService.map.msg_not_found"
                           formControlName="benPrimaryIdType">
                  <ng-option value="">{{langService.map.lbl_none}}</ng-option>
                  <ng-option *ngFor="let option of idTypes" [value]="option.lookupKey"
                             [disabled]="isPrimaryIdTypeDisabled(option.lookupKey)">
                    {{option.getName()}}
                  </ng-option>
                </ng-select>
              </div>
            </div>
          </div>
          <div class="col-sm-12 col-md-6">
            <div class="row">
              <label for="benPrimaryIdNumber"
                     class="col-sm-12 col-md-4 col-form-label">{{langService.map.id_number}}</label>
              <div class="col-md-8 col-sm-12 mb-4 position-relative">
                <input [ngClass]="fm.getInvalidClass('simpleSearch.beneficiary.benPrimaryIdNumber')"
                       id="benPrimaryIdNumber"
                       formControlName="benPrimaryIdNumber" type="text" class="form-control">
                <app-field-error-message
                  [control]="fm.getFormField('simpleSearch.beneficiary.benPrimaryIdNumber')"></app-field-error-message>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-sm-12 col-md-6">
            <div class="row">
              <label for="benSecIdType"
                     class="col-sm-12 col-md-4 col-form-label">{{langService.map.beneficiary_secondary_id}}</label>
              <div class="col-md-8 col-sm-12 mb-4 ng-select-wrapper">
                <ng-select [selectOnTab]="true" labelForId="benSecIdType" [clearable]="false"
                           placeholder="{{langService.map.select}}" id="benSecIdType"
                           [notFoundText]="langService.map.msg_not_found"
                           formControlName="benSecIdType">
                  <ng-option value="">{{langService.map.lbl_none}}</ng-option>
                  <ng-option *ngFor="let option of idTypes" [value]="option.lookupKey"
                             [disabled]="isSecondaryIdTypeDisabled(option.lookupKey)">
                    {{option.getName()}}
                  </ng-option>
                </ng-select>
              </div>
            </div>
          </div>
          <div class="col-sm-12 col-md-6">
            <div class="row">
              <label for="benSecIdNumber"
                     class="col-sm-12 col-md-4 col-form-label">{{langService.map.id_number}}</label>
              <div class="col-md-8 col-sm-12 mb-4 position-relative">
                <input [ngClass]="fm.getInvalidClass('simpleSearch.beneficiary.benSecIdNumber')" id="benSecIdNumber"
                       formControlName="benSecIdNumber" type="text" class="form-control">
                <app-field-error-message
                  [control]="fm.getFormField('simpleSearch.beneficiary.benSecIdNumber')"></app-field-error-message>
              </div>
            </div>
          </div>
        </div>
        <div formGroupName="arName" class="row">
          <div class="col-sm-12 col-md-6">
            <div class="row">
              <label for="arMethod"
                     class="col-sm-12 col-md-4 col-form-label">{{langService.map.search_method}}</label>
              <div class="col-md-8 col-sm-12 mb-4 ng-select-wrapper">
                <ng-select [selectOnTab]="true" labelForId="arMethod" [clearable]="false"
                           placeholder="{{langService.map.select}}" id="arMethod"
                           [notFoundText]="langService.map.msg_not_found"
                           formControlName="operator">
                  <ng-option *ngFor="let option of stringOperators" [value]="stringOperationMap[option.lookupKey]">
                    {{option.getName()}}
                  </ng-option>
                </ng-select>
              </div>
            </div>
          </div>
          <div class="col-sm-12 col-md-6">
            <div class="row">
              <label for="arName" class="col-sm-12 col-md-4 col-form-label">{{langService.map.arabic_name}}</label>
              <div class="col-md-8 col-sm-12 mb-4 position-relative">
                <input formControlName="value" id="arName" type="text" class="form-control"
                       [ngClass]="fm.getInvalidClass('simpleSearch.beneficiary.arName.value')">
                <app-field-error-message
                  [control]="fm.getFormField('simpleSearch.beneficiary.arName.value')"></app-field-error-message>
              </div>
            </div>
          </div>
        </div>
        <div formGroupName="enName" class="row">
          <div class="col-sm-12 col-md-6">
            <div class="row">
              <label for="enMethod"
                     class="col-sm-12 col-md-4 col-form-label">{{langService.map.search_method}}</label>
              <div class="col-md-8 col-sm-12 mb-4 ng-select-wrapper">
                <ng-select [selectOnTab]="true" labelForId="enMethod" [clearable]="false"
                           placeholder="{{langService.map.select}}" id="enMethod"
                           [notFoundText]="langService.map.msg_not_found"
                           formControlName="operator">
                  <ng-option *ngFor="let option of stringOperators" [value]="stringOperationMap[option.lookupKey]">
                    {{option.getName()}}
                  </ng-option>
                </ng-select>
              </div>
            </div>
          </div>
          <div class="col-sm-12 col-md-6">
            <div class="row">
              <label for="enName" class="col-sm-12 col-md-4 col-form-label">{{langService.map.english_name}}</label>
              <div class="col-md-8 col-sm-12 mb-4 position-relative">
                <input id="enName" formControlName="value" type="text" class="form-control"
                       [ngClass]="fm.getInvalidClass('simpleSearch.beneficiary.enName.value')">
                <app-field-error-message
                  [control]="fm.getFormField('simpleSearch.beneficiary.enName.value')"></app-field-error-message>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div> <!-- simple search-->
    <div class="accordion" id="advancedSearchAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header" id="criteriaHeader">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#criteriaWrapper"
                  aria-expanded="true" aria-controls="criteriaWrapper">
            {{langService.map.advanced_search}}
          </button>
        </h2>
        <div id="criteriaWrapper" class="accordion-collapse collapse" aria-labelledby="criteriaHeader"
             data-bs-parent="#advancedSearchAccordion">
          <div class="accordion-body">
            <div formGroupName="advancedSearch" id="advanced-search">
              <div>
                <div class="row" formGroupName="beneficiary">
                  <div class="col-sm-12 col-md-6">
                    <div class="row">
                      <label for="nationality"
                             class="col-sm-12 col-md-4 col-form-label">{{langService.map.lbl_nationality}}</label>
                      <div class="col-md-8 col-sm-12 mb-4 ng-select-wrapper">
                        <ng-select [selectOnTab]="true" labelForId="nationality" [clearable]="false"
                                   placeholder="{{langService.map.select}}" id="nationality"
                                   [notFoundText]="langService.map.msg_not_found"
                                   formControlName="benNationality">
                          <ng-option *ngFor="let option of nationalities" [value]="option.lookupKey">
                            {{option.getName()}}
                          </ng-option>
                        </ng-select>
                      </div>
                    </div>
                  </div>
                  <div class="col-sm-12 col-md-6">
                    <div class="row">
                      <label for="occuptionStatus"
                             class="col-sm-12 col-md-4 col-form-label">{{langService.map.employment_status}}</label>
                      <div class="col-md-8 col-sm-12 mb-4 ng-select-wrapper">
                        <ng-select [selectOnTab]="true" labelForId="occuptionStatus" [clearable]="false"
                                   placeholder="{{langService.map.select}}" id="occuptionStatus"
                                   [notFoundText]="langService.map.msg_not_found"
                                   formControlName="occuptionStatus">
                          <ng-option *ngFor="let option of employmentStatus" [value]="option.lookupKey">
                            {{option.getName()}}
                          </ng-option>
                        </ng-select>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-sm-12 col-md-6" formGroupName="beneficiary">
                    <div class="row">
                      <label for="phoneNumber1"
                             class="col-sm-12 col-md-4 col-form-label">{{langService.map.mobile_number}}</label>
                      <div class="col-md-8 col-sm-12 mb-4 position-relative">
                        <input formControlName="phoneNumber1" class="form-control" type="text" id="phoneNumber1"
                               [ngClass]="fm.getInvalidClass('advancedSearch.beneficiary.phoneNumber1')"
                               [mask]="inputMaskPatterns.NUMBER_ONLY">
                        <app-field-error-message
                          [control]="fm.getFormField('advancedSearch.beneficiary.phoneNumber1')"></app-field-error-message>
                      </div>
                    </div>
                  </div>
                  <div class="col-sm-12 col-md-6">
                    <div class="row">
                      <label for="aidLookupId"
                             class="col-sm-12 col-md-4 col-form-label">{{langService.map.aid_type}}</label>
                      <div class="col-md-8 col-sm-12 mb-4 ng-select-wrapper">
                        <ng-select [selectOnTab]="true" labelForId="aidLookupId" [clearable]="false"
                                   placeholder="{{langService.map.select}}" id="aidLookupId"
                                   [notFoundText]="langService.map.msg_not_found"
                                   formControlName="aidLookupId"
                                   [ngClass]="fm.getStatusClass('aidTab.0.aidLookupId')">
                          <ng-option *ngFor="let option of subAidLookupsArray" [value]="option.id">
                            {{option.getName()}}
                          </ng-option>
                        </ng-select>
                        <app-field-error-message
                          [control]="fm.getFormField('advancedSearch.aidLookupId')"></app-field-error-message>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div formGroupName="request">
                <div class="row">
                  <div class="col-sm-12 col-md-6">
                    <div class="row">
                      <label for="status"
                             class="col-sm-12 col-md-4 col-form-label">{{langService.map.request_status}}</label>
                      <div class="col-md-8 col-sm-12 mb-4 ng-select-wrapper">
                        <ng-select [selectOnTab]="true" labelForId="status" [clearable]="false"
                                   placeholder="{{langService.map.select}}" id="status"
                                   [notFoundText]="langService.map.msg_not_found"
                                   formControlName="status">
                          <ng-option *ngFor="let option of requestsStatus" [value]="option.lookupKey">
                            {{option.getName()}}
                          </ng-option>
                        </ng-select>
                      </div>
                    </div>
                  </div>
                  <div class="col-sm-12 col-md-6">
                    <div class="row">
                      <label for="requestType"
                             class="col-sm-12 col-md-4 col-form-label">{{langService.map.reason_of_request}}</label>
                      <div class="col-md-8 col-sm-12 mb-4 ng-select-wrapper">
                        <ng-select [selectOnTab]="true" labelForId="requestType" [clearable]="false"
                                   placeholder="{{langService.map.select}}" id="requestType"
                                   [notFoundText]="langService.map.msg_not_found"
                                   formControlName="requestType">
                          <ng-option *ngFor="let option of requestTypes" [value]="option.lookupKey">
                            {{option.getName()}}
                          </ng-option>
                        </ng-select>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-sm-12 col-md-6">
                    <div class="row">
                      <label for="creationDateFrom"
                             class="col-sm-12 col-md-4 col-form-label">{{langService.map.creation_date_from}}</label>
                      <div class="col-md-8 col-sm-12 mb-4 position-relative">
                        <div class="input-group">
                          <i class="input-group-text mdi mdi-calendar"></i>
                          <div class="form-control" formControlName="creationDateFrom"
                               id="creationDateFrom" [options]="datepickerOptionsMap.creationDateFrom"
                               (click)="dpCreationDateFrom.toggleCalendar()" #dpCreationDateFrom="angular-mydatepicker"
                               angular-mydatepicker
                               [ngClass]="fm.getStatusClass('advancedSearch.request.creationDateFrom')"
                               (inputFieldChanged)="onDateChange($event, 'creationDateFrom', 'creationDateTo')"></div>
                          <app-field-error-message
                            [control]="fm.getFormField('advancedSearch.request.creationDateFrom')"></app-field-error-message>
                        </div>
                        <span class="text-muted font-12">{{langService.map.msg_search_date_hint}}</span>
                      </div>
                    </div>
                  </div>
                  <div class="col-sm-12 col-md-6">
                    <div class="row">
                      <label for="creationDateTo"
                             class="col-sm-12 col-md-4 col-form-label">{{langService.map.creation_date_to}}</label>
                      <div class="col-md-8 col-sm-12 mb-4 position-relative">
                        <div class="input-group">
                          <i class="input-group-text mdi mdi-calendar"></i>
                          <div class="form-control" formControlName="creationDateTo"
                               id="creationDateTo" [options]="datepickerOptionsMap.creationDateTo"
                               (click)="dpCreationDateTo.toggleCalendar()" #dpCreationDateTo="angular-mydatepicker"
                               angular-mydatepicker
                               [ngClass]="fm.getStatusClass('advancedSearch.request.creationDateTo')"
                               (inputFieldChanged)="onDateChange($event, 'creationDateFrom', 'creationDateTo')"></div>
                          <app-field-error-message
                            [control]="fm.getFormField('advancedSearch.request.creationDateTo')"></app-field-error-message>
                        </div>
                        <span class="text-muted font-12">{{langService.map.msg_search_date_hint}}</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-sm-12 col-md-6">
                    <div class="row">
                      <label for="statusDateFrom"
                             class="col-sm-12 col-md-4 col-form-label">{{langService.map.status_date_from}}</label>
                      <div class="col-md-8 col-sm-12 mb-4 position-relative">
                        <div class="input-group">
                          <i class="input-group-text mdi mdi-calendar"></i>
                          <div class="form-control" formControlName="statusDateModifiedFrom"
                               id="statusDateFrom" [options]="datepickerOptionsMap.statusDateModifiedFrom"
                               (click)="dpStatusDateFrom.toggleCalendar()" #dpStatusDateFrom="angular-mydatepicker"
                               angular-mydatepicker
                               [ngClass]="fm.getStatusClass('advancedSearch.request.statusDateModifiedFrom')"
                               (inputFieldChanged)="onDateChange($event, 'statusDateModifiedFrom', 'statusDateModifiedTo')"></div>
                          <app-field-error-message
                            [control]="fm.getFormField('advancedSearch.request.statusDateModifiedFrom')"></app-field-error-message>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-sm-12 col-md-6">
                    <div class="row">
                      <label for="statusDateTo"
                             class="col-sm-12 col-md-4 col-form-label">{{langService.map.status_date_to}}</label>
                      <div class="col-md-8 col-sm-12 mb-4 position-relative">
                        <div class="input-group">
                          <i class="input-group-text mdi mdi-calendar"></i>
                          <div class="form-control" formControlName="statusDateModifiedTo"
                               id="statusDateTo" [options]="datepickerOptionsMap.statusDateModifiedTo"
                               (click)="dpStatusDateTo.toggleCalendar()" #dpStatusDateTo="angular-mydatepicker"
                               angular-mydatepicker
                               [ngClass]="fm.getStatusClass('advancedSearch.request.statusDateModifiedTo')"
                               (inputFieldChanged)="onDateChange($event, 'statusDateModifiedFrom', 'statusDateModifiedTo')"></div>
                          <app-field-error-message
                            [control]="fm.getFormField('advancedSearch.request.statusDateModifiedTo')"></app-field-error-message>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div><!-- advanced search -->
          </div>
        </div>
      </div>
    </div>
    <hr/>
    <div class="row">
      <div class="col-12 d-flex flex-row align-items-center justify-content-center ">
        <button (click)="onSearch()"
                class="btn btn-primary mx-2">{{langService.map.lbl_search}}</button>
        <button (click)="clearSearch()"
                class="btn btn-secondary mx-2">{{langService.map.btn_clear}}</button>
      </div>
    </div>
  </ng-template>
</form>
<ng-template #searchResult>
  <div *ngIf="requests.length">
    <div class="row">
      <div class="col-6 d-flex align-items-center justify-content-start">
        <button class="btn btn-link outline-none"
                tooltip="{{langService.map.btn_reload}}"
                (click)="reloadSearchResults()">
          <i class="mdi mdi-reload"></i></button>
      </div>
      <div class="col-6 d-flex align-items-center justify-content-end">
        <button class="btn btn-link outline-none"
                tooltip="{{langService.map.print}}"
                (click)="printResult()">
          <i class="mdi mdi-printer"></i></button>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <div class="table-responsive">
          <table class="table table-striped table-bordered caption-top">
            <thead role="rowgroup">
            <tr>
              <th class="serial-column">{{langService.map.request_number}}</th>
              <th class="date-column">{{langService.map.request_date}}</th>
              <th>{{langService.map.lbl_organization}}</th>
              <th>{{langService.map.created_by}}</th>
              <th>{{langService.map.request_status}}</th>
              <th>{{langService.map.request_aid_amount}}</th>
              <th>{{langService.map.total_approved_amount}}</th>
              <th class="date-column">{{langService.map.lbl_status_date_modified}}</th>
              <th>{{langService.map.lbl_actions}}</th>
            </tr>
            </thead>
            <tbody>
            <ng-container *ngFor="let request of requests;">
              <tr>
                <td class="serial-column">
                  <div class="d-flex flex-row">
                    <a href="#" (click)="showRequestDetails(request , $event)"
                       class="dir-ltr d-inline-block flex-grow-1 text-start"> {{request.requestFullSerial}} </a>
                    <i class="mdi mdi-file-hidden text-primary" *ngIf="request.isPartial"
                       tooltip="{{langService.map.partial_request}}"></i>
                  </div>
                </td>
                <td class="date-column">{{request.creationDateString}}</td>
                <td>{{request.orgAndBranchInfo?.getName()}}</td>
                <td>{{request.orgUserInfo.getName()}}</td>
                <td>{{request.statusInfo.getName()}}</td>
                <td>{{request.requestedAidAmount | mask:inputMaskPatterns.SEPARATOR:inputMaskPatterns.THOUSAND_SEPARATOR}}</td>
                <td>{{request.approvedAmount | mask:inputMaskPatterns.SEPARATOR:inputMaskPatterns.THOUSAND_SEPARATOR}}</td>
                <td class="date-column">{{request.statusDateModifiedString}}</td>
                <td class="table-actions">
                  <div class="d-flex flex-row">
                    <a tooltip="{{langService.map.show_aids}}" href="#" class="icon-btn"
                       (click)="request.showAid($event)">
                      <span class="badge bg-primary aid-badge">{{request.aidCount}}</span>
                    </a>
                    <a href="#" (click)="printRequest($event, request)" tooltip="{{langService.map.print_request_form}}"
                       class="icon-btn">
                      <i class="mdi mdi-printer"></i>
                    </a>
                    <a href="#" (click)="request.showLog($event)" tooltip="{{langService.map.show_logs}}"
                       class="icon-btn">
                      <i class="mdi mdi-history"></i>
                    </a>
                    <button *ngIf="empService.checkPermissions('EDIT_SUBVENTION_REQUEST')"
                            [disabled]="request.notUnderProcess()"
                            (click)="editRequest(request)" tooltip="{{langService.map.btn_edit}}"
                            class="btn icon-btn text-primary">
                      <i class="mdi mdi-book-edit"></i>
                    </button>
                    <button *ngIf="empService.checkPermissions('EDIT_SUBVENTION_REQUEST')"
                            (click)="cancelRequest(request)" tooltip="{{langService.map.btn_cancel}}"
                            [disabled]="request.notUnderProcess()" class="btn icon-btn text-primary">
                      <i class="mdi mdi-book-cancel"></i>
                    </button>
                    <button *ngIf="!request.notUnderProcess()"
                            (click)="deleteRequest(request)" tooltip="{{langService.map.btn_delete}}"
                            class="btn icon-btn text-primary">
                      <i class="mdi mdi-trash-can"></i>
                    </button>
                    <button *ngIf="empService.checkPermissions('SUBVENTION_AID_SEARCH')"
                            (click)="getRelatedBeneficiaryData(request)" tooltip="{{langService.map.inquire_beneficiary}}"
                            class="btn icon-btn text-primary">
                      <i class="mdi mdi-account-search"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </ng-container>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

</ng-template>
