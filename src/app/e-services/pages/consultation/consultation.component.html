<div class="d-flex flex-column">
  <div *ngIf="!accordionView && !fromDialog" class="row">
    <div class="col">
      <div class="col"><h1 class="h6 text-primary">{{lang.map.menu_consultations}}</h1></div>
    </div>
  </div>
  <tabs-list [accordionView]="accordionView">
    <tab [name]="tabsData.basicInfo.name" [hasError]="getTabInvalidStatus('basicInfo')"
         [template]="basicInfoTabTemplate" [title]="lang.map.lbl_basic_info"></tab>
    <tab [name]="tabsData.comments.name" [hasError]="getTabInvalidStatus('comments')"
         [template]="commentsTabTemplate" [title]="lang.map.comments"
         *ngIf="employeeService.isInternalUser()"></tab>
    <tab *ngIf="!accordionView" [name]="tabsData.attachments.name" [hasError]="getTabInvalidStatus('attachments')"
         [template]="attachmentsTabTemplate" [title]="lang.map.attachments"></tab>
    <tab [name]="tabsData.recommendations.name" [hasError]="getTabInvalidStatus('recommendations')"
         [template]="recommendationsTemplate" [title]="lang.map.recommendations"
         *ngIf="(fromDialog || accordionView) && employeeService.isInternalUser()" [disabled]="!model?.id"></tab>
  </tabs-list>

  <ng-template #basicInfoTabTemplate>
    <fieldset [disabled]="readonly">
      <form [formGroup]="form" autocomplete="off">
        <div class="row mb-3">
          <div class="col-md-6 col-sm-12">
            <div class="row">
              <label asteriskIfRequired="category" for="category"
                     class="col-md-4 col-sm-12 col-form-label">{{lang.map.consulting_type}}</label>
              <div class="col-md-8 mb-3 position-relative col-sm-12 ng-select-wrapper">
                <ng-select [readonly]="readonly" validationClasses="category" id="category" formControlName="category">
                  <ng-option [value]="category.lookupKey"
                             *ngFor="let category of categories">{{category.getName()}}</ng-option>
                </ng-select>
                <app-field-error-message controlName="category"></app-field-error-message>
              </div>
            </div>
          </div>
          <div *ngIf="isInternalUser" class="col-md-6 col-sm-12">
            <div class="row">
              <label asteriskIfRequired="competentDepartmentID" for="competentDepartmentID"
                     class="col-md-4 col-sm-12 col-form-label">{{lang.map.competent_dep}}</label>
              <div class="col-md-8 mb-3 position-relative col-sm-12 ng-select-wrapper">
                <ng-select [readonly]="readonly" (change)="onCompetentDepChange($event)"
                           validationClasses="competentDepartmentID"
                           formControlName="competentDepartmentID"
                           id="competentDepartmentID">
                  <ng-option [value]="dep.id" *ngFor="let dep of departments">{{dep.getName()}}</ng-option>
                </ng-select>
                <app-field-error-message controlName="competentDepartmentID"></app-field-error-message>
              </div>
            </div>
          </div>
          <div *ngIf="!isInternalUser" class="col-md-6 col-sm-12">
            <div class="row">
              <label asteriskIfRequired="mobileNo" for="mobileNo"
                     class="col-md-4 col-sm-12 col-form-label">{{lang.map.lbl_phone}}</label>
              <div class="col-md-8 mb-3 position-relative col-sm-12">
                <!--suppress XmlDuplicatedId -->
                <input id="mobileNo" validationClasses="mobileNo" formControlName="mobileNo" class="form-control">
                <app-field-error-message controlName="mobileNo"></app-field-error-message>
              </div>
            </div>
          </div>
          <!--<div *ngIf="!isInternalUser" class="col-md-6 col-sm-12">
            <div class="row">
              <label asteriskIfRequired="organizationId" for="organizationId"
                     class="col-md-4 col-sm-12 col-form-label">{{lang.map.lbl_organization}}</label>
              <div class="col-md-8 mb-3 position-relative col-sm-12 ng-select-wrapper">
                &lt;!&ndash;suppress XmlDuplicatedId &ndash;&gt;
                <ng-select [readonly]="readonly" validationClasses="organizationId"
                           formControlName="organizationId" id="organizationId">
                  <ng-option [value]="org.id" *ngFor="let org of organizations">{{org.getName()}}</ng-option>
                </ng-select>
                <app-field-error-message controlName="organizationId"></app-field-error-message>
              </div>
            </div>
          </div>-->
        </div>
        <div class="row mb-3">
          <div class="col-md-6 col-sm-12">
            <div class="row">
              <label asteriskIfRequired="fullName" for="fullName"
                     class="col-md-4 col-sm-12 col-form-label">{{lang.map.full_name}}</label>
              <div class="col-md-8 mb-3 position-relative col-sm-12">
                <input id="fullName" validationClasses="fullName" formControlName="fullName" class="form-control">
                <app-field-error-message controlName="fullName"></app-field-error-message>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-sm-12">
            <div class="row">
              <label asteriskIfRequired="email" for="email"
                     class="col-md-4 col-sm-12 col-form-label">{{lang.map.lbl_email}}</label>
              <div class="col-md-8 mb-3 position-relative col-sm-12">
                <input id="email" validationClasses="email" formControlName="email" class="form-control">
                <app-field-error-message controlName="email"></app-field-error-message>
              </div>
            </div>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6 col-sm-12" *ngIf="isInternalUser">
            <div class="row">
              <label asteriskIfRequired="mobileNo" for="mobileNo"
                     class="col-md-4 col-sm-12 col-form-label">{{lang.map.lbl_phone}}</label>
              <div class="col-md-8 mb-3 position-relative col-sm-12">
                <!--suppress XmlDuplicatedId -->
                <input id="mobileNo" validationClasses="mobileNo" formControlName="mobileNo" class="form-control">
                <app-field-error-message controlName="mobileNo"></app-field-error-message>
              </div>
            </div>
          </div>
          <div *ngIf="isInternalUser" class="col-md-6 col-sm-12">
            <div class="row">
              <label asteriskIfRequired="organizationId" for="organizationId"
                     class="col-md-4 col-sm-12 col-form-label">{{lang.map.lbl_organization}}</label>
              <div class="col-md-8 mb-3 position-relative col-sm-12 ng-select-wrapper">
                <!--suppress XmlDuplicatedId -->
                <ng-select [readonly]="readonly" validationClasses="organizationId"
                           formControlName="organizationId" id="organizationId">
                  <ng-option [value]="org.id" *ngFor="let org of organizations">{{org.getName()}}</ng-option>
                </ng-select>
                <app-field-error-message controlName="organizationId"></app-field-error-message>
              </div>
            </div>
          </div>
        </div>
        <div class="row mb-3">
          <label asteriskIfRequired="requestBody" for="requestBody"
                 class="col-md-2 col-sm-12 col-form-label">{{lang.map.request_body}}</label>
          <div class="col-md-10 col-sm-12 mb-3 position-relative">
        <textarea rows="5" id="requestBody" validationClasses="requestBody" formControlName="requestBody"
                  class="form-control"></textarea>
            <app-field-error-message controlName="requestBody"></app-field-error-message>
          </div>
        </div>
      </form>
    </fieldset>
  </ng-template>

  <ng-template #commentsTabTemplate>
    <div class="d-flex flex-row align-items-center justify-content-start">
      <button [disabled]="!isAddCommentAllowed()" (click)="commentsCtrl.openCommentDialog()"
              class="d-inline-block btn p-0 icon-btn"><i
        class="mdi mdi-plus-box text-primary"></i></button>
    </div>
    <app-comments #commentsCtrl [caseId]="model?.id" [service]="service.commentService"
                  [readonly]="readonly"></app-comments>
  </ng-template>

  <ng-template #attachmentsTabTemplate>
    <div class="d-flex flex-row align-items-center justify-content-start">
      <button [disabled]="isAttachmentReadonly()" (click)="attachmentsCtrl.openUploadDialog()"
              class="d-inline-block btn p-0 icon-btn"><i
        class="mdi mdi-plus-box text-primary"></i></button>
    </div>
    <app-documents #attachmentsCtrl [caseId]="model?.id" [service]="service.documentService"
                   [readonly]="isAttachmentReadonly()"></app-documents>
  </ng-template>

  <ng-template #recommendationsTemplate>
    <app-recommendations [gridStyle]="false" [disabled]="!allowEditRecommendations"
                         [case]="model"
                         [caseId]="model?.id"
                         [service]="service.recommendationService"></app-recommendations>
  </ng-template>
  <div class="mb-3 d-flex align-items-center justify-content-center">
    <button (click)="save.next(saveTypes.FINAL)"
            [disabled]="form.invalid || model?.alreadyStarted()"
            class="btn btn-primary shadow-sm">{{lang.map.btn_save}}</button>
    <button (click)="launch()" [disabled]="form.invalid || !model?.canStart()"
            class="btn btn-primary shadow-sm mx-3">{{lang.map.launch}}</button>
    <button (click)="navigateBack()" class="btn btn-secondary shadow-sm">{{lang.map.btn_cancel}}</button>
  </div>
</div>
