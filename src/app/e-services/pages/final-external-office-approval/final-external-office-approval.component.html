<div class="d-flex flex-column">
  <div *ngIf="!fromDialog" class="row mb-3">
    <div class="col"><h1 class="h6 text-primary">{{lang.map.menu_final_external_office_approval}}</h1></div>
  </div>
  <div class="row">
    <form autocomplete="off" [formGroup]="form" id="form">
      <tabs-list [accordionView]="accordionView" (onTabChange)="onTabChange($event)">
        <tab [name]="tabsData.basicInfo.name" [hasError]="getTabInvalidStatus('basicInfo')"
             [template]="basicInfoTabTemplate" [title]="lang.map.lbl_basic_info"></tab>
        <tab [name]="tabsData.bankAccounts.name" [hasError]="getTabInvalidStatus('bankAccounts')"
             [template]="bankAccountsTemplate" [title]="lang.map.bank_details"></tab>
        <tab [name]="tabsData.managers.name" [hasError]="getTabInvalidStatus('managers')"
             [template]="managersTabTemplate" [title]="lang.map.managers"></tab>
        <tab [name]="tabsData.branches.name" [hasError]="getTabInvalidStatus('branches')"
             [template]="branchesTabTemplate" [title]="lang.map.branches"></tab>
        <tab [name]="tabsData.comments.name" [hasError]="getTabInvalidStatus('comments')"
             [template]="commentsTabTemplate" [title]="lang.map.comments"
             *ngIf="employeeService.isInternalUser()"></tab>
        <tab *ngIf="!accordionView" [name]="tabsData.attachments.name" [hasError]="getTabInvalidStatus('attachments')"
             [template]="attachmentsTabTemplate" [title]="lang.map.attachments"></tab>
        <tab [name]="tabsData.logs.name" [hasError]="getTabInvalidStatus('logs')"
             [template]="logsTemplate" [title]="lang.map.logs" *ngIf="fromDialog" [disabled]="!model?.id"></tab>
      </tabs-list>
      <ng-template #basicInfoTabTemplate>
        <div formGroupName="basicInfo">
          <div class="row mb-3">
            <div class="col-sm-12 col-md-6">
              <div class="row d-flex flex-column flex-md-row">
                <label for="requestType" asteriskIfRequired="requestType"
                       class="col-sm-12 col-md-4 col-form-label">{{lang.map.request_type}}</label>
                <div class="col-md-8 col-sm-12 mb-4 ng-select-wrapper">
                  <ng-select [selectOnTab]="true" labelForId="requestType" [clearable]="true"
                             placeholder="{{lang.map.select}}" id="requestType"
                             [notFoundText]="lang.map.msg_not_found"
                             [readonly]="!isEditRequestTypeAllowed()"
                             formControlName="requestType" validationClasses="requestType">
                    <ng-option *ngFor="let option of requestTypesList" [value]="option.lookupKey">
                      {{option.getName()}}
                    </ng-option>
                  </ng-select>
                  <app-field-error-message controlName="requestType"></app-field-error-message>
                </div>
              </div>
            </div>
            <div class="col-sm-12 col-md-6">
              <div *ngIf="isShowInitialLicenseField()"
                   class="row d-flex flex-column flex-md-row">
                <label asteriskIfRequired="initialLicenseFullserial" for="initialLicenseFullserial"
                       class="col-sm-12 col-md-4 col-form-label">{{lang.map.initial_license_number}}</label>
                <div class="col-md-8 col-sm-12 mb-4 position-relative">
                  <div class="input-group">
                    <button *ngIf="isEditLicenseAllowed()" type="button"
                            (click)="licenseSearch($event)"
                            class="input-group-text">
                      <i class="mdi {{fileIconsEnum.SEARCH}} text-primary"></i></button>
                    <input (keydown.enter)="isEditLicenseAllowed() && licenseSearch($event)"
                           formControlName="initialLicenseFullserial"
                           type="text" validationClasses="initialLicenseFullserial" class="form-control"
                           id="initialLicenseFullserial" trimInput [readOnly]="!isEditLicenseAllowed()">
                    <app-field-error-message controlName="initialLicenseFullserial"></app-field-error-message>
                  </div>

                </div>
              </div>
              <div *ngIf="isShowNormalLicenseField()"
                   class="row d-flex flex-column flex-md-row">
                <label asteriskIfRequired="oldLicenseFullserial" for="oldLicenseFullserial"
                       class="col-sm-12 col-md-4 col-form-label">{{lang.map.license_number}}</label>
                <div class="col-md-8 col-sm-12 mb-4 position-relative">
                  <div class="input-group">
                    <button *ngIf="isEditLicenseAllowed()" type="button" (click)="licenseSearch($event)"
                            class="input-group-text">
                      <i class="mdi {{fileIconsEnum.SEARCH}} text-primary"></i></button>
                    <input (keydown.enter)="isEditLicenseAllowed() && licenseSearch($event)"
                           formControlName="oldLicenseFullserial"
                           type="text" validationClasses="oldLicenseFullserial" class="form-control"
                           id="oldLicenseFullserial" trimInput [readOnly]="!isEditLicenseAllowed()">
                    <app-field-error-message controlName="oldLicenseFullserial"></app-field-error-message>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="selectedLicense">
            <app-table #table
                       [data]="[selectedLicense]"
                       [columns]="service.selectLicenseDisplayColumns">
              <table cdk-table [dataSource]="table.dataSource" class="table table-striped table-bordered caption-top">
                <ng-container cdkColumnDef="arName">
                  <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.office_arabic_name}}</th>
                  <td cdk-cell *cdkCellDef="let row"> {{row.arName}} </td>
                </ng-container>
                <ng-container cdkColumnDef="enName">
                  <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.office_english_name}}</th>
                  <td cdk-cell *cdkCellDef="let row"> {{row.enName}} </td>
                </ng-container>
                <ng-container cdkColumnDef="licenseNumber">
                  <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.license_number}}</th>
                  <td cdk-cell *cdkCellDef="let row"> {{row.licenseNumber}} </td>
                </ng-container>
                <ng-container cdkColumnDef="fullSerial">
                  <!-- full serial will be shown as License number, so label is license number -->
                  <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.license_number}}</th>
                  <td cdk-cell *cdkCellDef="let row"> {{row.fullSerial}} </td>
                </ng-container>
                <ng-container cdkColumnDef="status">
                  <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.license_status}}</th>
                  <td cdk-cell *cdkCellDef="let row"> {{row.licenseStatusInfo.getName()}} </td>
                </ng-container>
                <ng-container cdkColumnDef="endDate">
                  <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.license_end_date}}</th>
                  <td cdk-cell
                      *cdkCellDef="let row"> {{!row.licenseEndDate ? '' : row.licenseEndDate|date: 'mediumDate'}} </td>
                </ng-container>
                <ng-container cdkColumnDef="actions">
                  <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.lbl_actions}}</th>
                  <td cdk-cell *cdkCellDef="let row">
                    <button class="btn btn-link outline-none mx-2"
                            tooltip="{{lang.map.view_license}}"
                            (click)="viewLicenseAsPDF(row)">
                      <i class="mdi {{fileIconsEnum.PDF}}"></i></button>
                  </td>
                </ng-container>
                <tr *cdkNoDataRow>
                  <td colspan="20">{{lang.map.no_records_to_display}}</td>
                </tr>
                <tr cdk-header-row *cdkHeaderRowDef="service.selectLicenseDisplayColumns"></tr>
                <tr cdk-row *cdkRowDef="let row; columns: service.selectLicenseDisplayColumns;"></tr>
              </table>
            </app-table>
          </div>
          <div class="row mb-3">
            <div class="col-sm-12 col-md-6">
              <div class="row d-flex flex-column flex-md-row">
                <label for="country" asteriskIfRequired="country"
                       class="col-sm-12 col-md-4 col-form-label">{{lang.map.country}}</label>
                <div class="col-md-8 col-sm-12 mb-4 ng-select-wrapper">
                  <ng-select [selectOnTab]="true" labelForId="country" [clearable]="false"
                             placeholder="{{lang.map.select}}" id="country"
                             (change)="handleCountryChange($event)" appendTo="body"
                             [notFoundText]="lang.map.msg_not_found" [readonly]="!isEditCountryAllowed()"
                             formControlName="country" validationClasses="country">
                    <ng-option *ngFor="let option of countriesList" [value]="option.id"
                               [disabled]="!option.isActive()">
                      {{option.getName()}}
                    </ng-option>
                  </ng-select>
                  <app-field-error-message controlName="country"></app-field-error-message>
                </div>
              </div>
            </div>
            <div class="col-sm-12 col-md-6">
              <div class="row d-flex flex-column flex-md-row">
                <label asteriskIfRequired="region" for="region"
                       class="col-sm-12 col-md-4 col-form-label">{{lang.map.region}}</label>
                <div class="col-md-8 col-sm-12 mb-4 ng-select-wrapper">
                  <!--<ng-select [selectOnTab]="true" labelForId="region" [clearable]="false"
                             placeholder="{{lang.map.select}}" id="region"
                             [notFoundText]="lang.map.msg_not_found" [readonly]="!isEditCountryAllowed()"
                             formControlName="region" validationClasses="region">
                    <ng-option *ngFor="let option of regionsList" [value]="option.id"
                               [disabled]="!option.isActive()">
                      {{option.getName()}}
                    </ng-option>
                  </ng-select>-->
                  <input formControlName="region" type="text" [readOnly]="!isEditCountryAllowed()"
                         validationClasses="region" class="form-control" id="region">
                  <app-field-error-message controlName="region"></app-field-error-message>
                </div>
              </div>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-sm-12 col-md-6">
              <div class="row d-flex flex-column flex-md-row">
                <label asteriskIfRequired="externalOfficeName" for="externalOfficeName"
                       class="col-sm-12 col-md-4 col-form-label">{{lang.map.external_office_name}}</label>
                <div class="col-md-8 col-sm-12 mb-4 position-relative">
                  <input id="externalOfficeName" validationClasses="externalOfficeName"
                         [readOnly]="(isExtendOrCancelRequestType() || readonly)"
                         formControlName="externalOfficeName" trimInput class="form-control" type="text">
                  <app-field-error-message controlName="externalOfficeName"></app-field-error-message>
                </div>
              </div>
            </div>
            <div class="col-sm-12 col-md-6">
              <div class="row d-flex flex-column flex-md-row">
                <label for="establishmentDate" asteriskIfRequired="establishmentDate"
                       class="col-sm-12 col-md-4 col-form-label">{{lang.map.establishment_date}}</label>
                <div class="col-md-8 col-sm-12 mb-4 position-relative">
                  <div class="input-group">
                    <i class="input-group-text mdi mdi-calendar"></i>
                    <div class="form-control" formControlName="establishmentDate"
                         [ngClass]="{'input-disabled': (isExtendOrCancelRequestType() || readonly)}"
                         id="establishmentDate" [options]="datepickerOptionsMap.establishmentDate"
                         (click)="!isExtendOrCancelRequestType() && !readonly && dpEstablishmentDate.toggleCalendar()"
                         #dpEstablishmentDate="angular-mydatepicker"
                         angular-mydatepicker validationClasses="establishmentDate"></div>
                    <app-field-error-message controlName="establishmentDate"></app-field-error-message>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-sm-12 col-md-6">
              <div class="row d-flex flex-column flex-md-row">
                <label asteriskIfRequired="recordNo" for="recordNo"
                       class="col-sm-12 col-md-4 col-form-label">{{lang.map.record_number}}</label>
                <div class="col-md-8 col-sm-12 mb-4 position-relative">
                  <input id="recordNo" validationClasses="recordNo"
                         [readOnly]="(isExtendOrCancelRequestType() || readonly)"
                         formControlName="recordNo" trimInput class="form-control" type="text">
                  <app-field-error-message controlName="recordNo"></app-field-error-message>
                </div>
              </div>
            </div>
            <div class="col-sm-12 col-md-6">
              <div class="row d-flex flex-column flex-md-row">
                <label asteriskIfRequired="address" for="address"
                       class="col-sm-12 col-md-4 col-form-label">{{lang.map.lbl_address}}</label>
                <div class="col-md-8 col-sm-12 mb-4 position-relative">
                  <input id="address" validationClasses="address"
                         [readOnly]="(isExtendOrCancelRequestType() || readonly)"
                         formControlName="address" trimInput class="form-control" type="text">
                  <app-field-error-message controlName="address"></app-field-error-message>
                </div>
              </div>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-sm-12 col-md-6">
              <div class="row d-flex flex-column flex-md-row">
                <label asteriskIfRequired="postalCode" for="postalCode"
                       class="col-sm-12 col-md-4 col-form-label">{{lang.map.lbl_po_box_num}}</label>
                <div class="col-md-8 col-sm-12 mb-4 position-relative">
                  <input id="postalCode" validationClasses="postalCode"
                         [readOnly]="(isExtendOrCancelRequestType() || readonly)"
                         formControlName="postalCode" trimInput class="form-control" type="text">
                  <app-field-error-message controlName="postalCode"></app-field-error-message>
                </div>
              </div>
            </div>
            <div class="col-sm-12 col-md-6">
              <div class="row d-flex flex-column flex-md-row">
                <label asteriskIfRequired="phone" for="phone"
                       class="col-sm-12 col-md-4 col-form-label">{{lang.map.lbl_phone}}</label>
                <div class="col-md-8 col-sm-12 mb-4 position-relative">
                  <input id="phone" validationClasses="phone" [readOnly]="(isExtendOrCancelRequestType() || readonly)"
                         formControlName="phone" trimInput class="form-control" type="text">
                  <app-field-error-message controlName="phone"></app-field-error-message>
                </div>
              </div>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-sm-12 col-md-6">
              <div class="row d-flex flex-column flex-md-row">
                <label asteriskIfRequired="fax" for="fax"
                       class="col-sm-12 col-md-4 col-form-label">{{lang.map.fax_number}}</label>
                <div class="col-md-8 col-sm-12 mb-4 position-relative">
                  <input id="fax" validationClasses="fax" [readOnly]="(isExtendOrCancelRequestType() || readonly)"
                         formControlName="fax" trimInput class="form-control" type="text">
                  <app-field-error-message controlName="fax"></app-field-error-message>
                </div>
              </div>
            </div>
            <div class="col-sm-12 col-md-6">
              <div class="row d-flex flex-column flex-md-row">
                <label asteriskIfRequired="email" for="email"
                       class="col-sm-12 col-md-4 col-form-label">{{lang.map.lbl_email}}</label>
                <div class="col-md-8 col-sm-12 mb-4 position-relative">
                  <input id="email" validationClasses="email" [readOnly]="(isExtendOrCancelRequestType() || readonly)"
                         formControlName="email" trimInput class="form-control" type="text">
                  <app-field-error-message controlName="email"></app-field-error-message>
                </div>
              </div>
            </div>
          </div>
          <div class="row mb-3">
            <label asteriskIfRequired="description" for="description"
                   class="col-md-2 col-sm-12 col-form-label">{{lang.map.special_explanations}}</label>
            <div class="col-md-10 col-sm-12 mb-3 position-relative">
              <textarea rows="5" id="description" validationClasses="description" formControlName="description"
                        class="form-control" [readOnly]="readonly"></textarea>
              <app-field-error-message controlName="description"></app-field-error-message>
            </div>
          </div>
        </div>
      </ng-template>
      <ng-template #bankAccountsTemplate>
        <bank-account #bankAccountsTab [countriesList]="countriesList"
                      [list]="model?.bankAccountList || []"
                      [caseType]="model?.caseType"
                      [readonly]="(isExtendOrCancelRequestType() || readonly)"
                      (readyEvent)="bankDetailsTabStatus = $event"></bank-account>
      </ng-template>
      <ng-template #managersTabTemplate>
        <executive-management #managersTab [countriesList]="countriesList"
                              [readonly]="(isExtendOrCancelRequestType() || readonly)"
                              [jobTitlesList]="jobTitlesList"
                              [list]="model?.executiveManagementList || []"
                              (readyEvent)="managersTabStatus = $event"></executive-management>
      </ng-template>
      <ng-template #branchesTabTemplate>
        <bank-branch #branchesTab
                     [readonly]="(isExtendOrCancelRequestType() || readonly)"
                     [list]="model?.branchList || []"
                     (readyEvent)="branchesTabStatus = $event"></bank-branch>
      </ng-template>
      <ng-template #commentsTabTemplate>
        <div class="d-flex flex-row align-items-center justify-content-start">
          <button [disabled]="!isAddCommentAllowed()" (click)="commentsCtrl.openCommentDialog()"
                  class="d-inline-block btn p-0 icon-btn"><i
            class="mdi mdi-plus-box text-primary"></i></button>
        </div>
        <app-comments #commentsCtrl [caseId]="model?.id" [service]="service.commentService"
                      [readonly]="readonly"></app-comments>
      </ng-template>
      <ng-template #attachmentsTabTemplate>
        <div class="d-flex flex-row align-items-center justify-content-start">
          <button [disabled]="isAttachmentReadonly()" (click)="attachmentsCtrl.openUploadDialog()"
                  class="d-inline-block btn p-0 icon-btn"><i
            class="mdi mdi-plus-box text-primary"></i></button>
        </div>
        <app-documents #attachmentsCtrl [caseId]="model?.id" [service]="service.documentService"
                       [readonly]="isAttachmentReadonly()"></app-documents>
      </ng-template>
      <ng-template #logsTemplate>
        <!--<request-recommendations [record]="model"></request-recommendations>-->
        <log-viewer [caseId]="model!.getCaseId()" [service]="service.actionLogService"
                    [hideItemLocation]="true" [hideViewedAction]="true"></log-viewer>
      </ng-template>

      <div *ngIf="!fromDialog" class="d-flex align-items-center justify-content-center gap-2 mb-3">
        <button [disabled]="(form.invalid || model?.alreadyStarted())" (click)="save.next(saveTypes.FINAL)"
                class="btn shadow-sm btn-primary">{{lang.map.btn_save}}</button>
        <button [disabled]="!model?.canDraft()" (click)="save.next(saveTypes.DRAFT)"
                class="btn shadow-sm btn-primary">{{lang.map.save_as_draft}}</button>
        <button [disabled]="!model?.canStart()" (click)="launch$.next(null)"
                class="btn btn-primary">{{lang.map.launch}}</button>
        <button class="btn shadow-sm btn-secondary" (click)="resetForm$.next()">{{lang.map.btn_reset}}</button>
      </div>
    </form>
  </div>
</div>

