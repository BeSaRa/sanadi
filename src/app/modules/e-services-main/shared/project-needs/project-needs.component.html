<div [formGroup]="form">
  <div formGroupName="projectNeeds">
    <ng-container
      *ngFor="let account of projectNeedsForm.controls; let i = index"
    >
      <div [formGroupName]="i">
        <div class="row">
          <!-- ProjectName Name -->
          <div class="col-sm-12 col-md-8 mb-4 position-relative">
            <label
              asteriskIfRequired="projectName"
              for="projectName"
              class="form-label"
            >{{ lang.map.project_name }}</label
            >
            <input
              id="projectName"
              validationClasses="projectName"
              formControlName="projectName"
              trimInput maxlength="300"
              class="form-control"
            />
            <app-field-error-message
              controlName="projectName"
            ></app-field-error-message>
          </div>
          <!-- Total Cost -->
          <div class="col-sm-12 col-md-4 mb-4 position-relative">
            <label
              asteriskIfRequired="totalCost"
              for="totalCost"
              class="form-label"
            >{{ lang.map.total_cost }}</label
            >
            <input id="totalCost"
                   validationClasses="totalCost"
                   formControlName="totalCost"
                   trimInput [mask]="inputMaskPatterns.DECIMAL_WITH_SEPARATOR(2)"
                   [thousandSeparator]="inputMaskPatterns.THOUSAND_SEPARATOR"
                   class="form-control"
            />
            <app-field-error-message
              controlName="totalCost"
            ></app-field-error-message>
          </div>
        </div>
        <div class="row">
          <div class="col-sm-12 mb-4 position-relative">
            <label
              class="form-label"
              asteriskIfRequired="projectDescription"
              for="projectDescription"
            >{{ lang.map.project_description }}</label
            >
            <textarea name="projectDescription"
                      formControlName="projectDescription"
                      validationClasses="projectDescription"
                      id="projectDescription"
                      rows="4" [maxlength]="customValidators.defaultLengths.EXPLANATIONS"
                      class="form-control"
            ></textarea>
            <app-field-error-message
              controlName="projectDescription"
            ></app-field-error-message>
          </div>
        </div>

        <div class="row">
          <div class="col-sm-12 mb-4 position-relative">
            <label class="form-label" asteriskIfRequired="goals" for="goals">{{
              lang.map.project_goals
              }}</label>
            <textarea name="goals"
                      formControlName="goals"
                      validationClasses="goals"
                      id="goals"
                      rows="4" [maxlength]="customValidators.defaultLengths.EXPLANATIONS"
                      class="form-control"
            ></textarea>
            <app-field-error-message
              controlName="goals"
            ></app-field-error-message>
          </div>
        </div>

        <div class="row">
          <div class="col-sm-12 mb-4 position-relative">
            <label
              class="form-label"
              asteriskIfRequired="beneficiaries"
              for="beneficiaries"
            >{{ lang.map.lbl_beneficiaries }}</label
            >
            <textarea name="beneficiaries"
                      formControlName="beneficiaries"
                      validationClasses="beneficiaries"
                      id="beneficiaries"
                      rows="4" [maxlength]="customValidators.defaultLengths.EXPLANATIONS"
                      class="form-control"
            ></textarea>
            <app-field-error-message
              controlName="beneficiaries"
            ></app-field-error-message>
          </div>
        </div>

        <div class="d-flex flex-row align-items-center justify-content-center">
          <button
            (click)="save()"
            [disabled]="readonly"
            *ngIf="!readonly && !viewOnly"
            class="btn btn-primary m-2"
          >
            {{ editRecordIndex > -1 ? lang.map.btn_save : lang.map.btn_add }}
          </button>
          <button (click)="cancel()" class="btn btn-secondary m-2">
            {{ lang.map.btn_cancel }}
          </button>
        </div>
      </div>
    </ng-container>
  </div>
</div>

<app-page-header
  [hidden]="projectNeedsForm.controls.length"
  pageTitle="project_needs"
  [clickOnNew$]="add$"
  [addPermission]="isAddingAllowed()"
></app-page-header>

<table
  class="table mt-3 table-striped table-bordered caption-top"
  cdk-table
  [dataSource]="projectNeeds"
>
  <ng-container cdkColumnDef="projectName">
    <th cdk-header-cell *cdkHeaderCellDef>{{ lang.map.project_name }}</th>
    <td cdk-cell *cdkCellDef="let row">{{ row.projectName }}</td>
    <td cdk-footer-cell *cdkFooterCellDef></td>
  </ng-container>
  <ng-container cdkColumnDef="projectDescription">
    <th cdk-header-cell *cdkHeaderCellDef>
      {{ lang.map.project_description }}
    </th>
    <td cdk-cell *cdkCellDef="let row">{{ row.projectDescription }}</td>
    <td cdk-footer-cell *cdkFooterCellDef></td>
  </ng-container>

  <ng-container cdkColumnDef="beneficiaries">
    <th cdk-header-cell *cdkHeaderCellDef>{{ lang.map.lbl_beneficiaries }}</th>
    <td cdk-cell *cdkCellDef="let row">{{ row.beneficiaries }}</td>
    <td cdk-footer-cell *cdkFooterCellDef></td>
  </ng-container>
  <ng-container cdkColumnDef="goals">
    <th cdk-header-cell *cdkHeaderCellDef>{{ lang.map.goals }}</th>
    <td cdk-cell *cdkCellDef="let row">{{ row.goals }}</td>
    <td cdk-footer-cell *cdkFooterCellDef></td>
  </ng-container>
  <ng-container cdkColumnDef="totalCost">
    <th cdk-header-cell *cdkHeaderCellDef>{{ lang.map.total_cost }}</th>
    <td cdk-cell class="text-end"
        *cdkCellDef="let row">{{ (row.totalCost ?? 0) | mask:inputMaskPatterns.SEPARATOR:inputMaskPatterns.THOUSAND_SEPARATOR}}</td>
  </ng-container>
  <ng-container cdkColumnDef="actions">
    <th cdk-header-cell *cdkHeaderCellDef>{{ lang.map.lbl_actions }}</th>
    <td cdk-cell *cdkCellDef="let row; let i = index" class="table-actions">
      <div class="d-flex flex-row">
        <button
          (click)="deleteRow($event, row, i)"
          class="icon-btn text-primary"
          [disabled]="readonly"
          tooltip="{{ lang.map.btn_delete }}"
        >
          <i class="mdi mdi-close-box"></i>
        </button>
        <button
          (click)="editRow($event, row, i)"
          class="icon-btn text-primary"
          [disabled]="readonly"
          tooltip="{{ lang.map.btn_edit }}"
        >
          <i class="mdi mdi-pen"></i>
        </button>
        <button
          (click)="viewRow($event, row, i)"
          class="icon-btn text-primary"
          tooltip="{{ lang.map.view }}"
        >
          <i class="mdi mdi-eye"></i>
        </button>
      </div>
    </td>
  </ng-container>
  <ng-container cdkColumnDef="totalCostFooterLabel">
    <td cdk-footer-cell [colSpan]="footerLabelColSpan" class="text-end" *cdkFooterCellDef="let row">
      <span><b> {{lang.map.total_cost}}: </b></span>
    </td>
  </ng-container>
  <ng-container cdkColumnDef="totalCostFooter">
    <td cdk-footer-cell class="text-end" *cdkFooterCellDef="let row">
      <span><b>{{calculateTotalCost() | mask:inputMaskPatterns.SEPARATOR:inputMaskPatterns.THOUSAND_SEPARATOR }}</b></span>
    </td>
  </ng-container>
  <tr cdk-header-row *cdkHeaderRowDef="columns"></tr>
  <tr cdk-row *cdkRowDef="let row; columns: columns"></tr>
  <tr cdk-footer-row *cdkFooterRowDef="footerColumns" [hidden]="!list || list.length === 0"></tr>

  <tr *cdkNoDataRow>
    <td colspan="100" class="text-center">
      {{ lang.map.no_records_to_display }}
    </td>
  </tr>
</table>
