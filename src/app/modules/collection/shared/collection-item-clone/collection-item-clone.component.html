<app-page-header *ngIf="!approvalMode" [clickOnNew$]="add$" [disableAdd]="!!item || disableAdd"
                 [pageTitle]="'collection_items'"></app-page-header>
<app-page-header *ngIf="approvalMode" [pageTitle]="'collection_items'"></app-page-header>
<form *ngIf="!!item" [formGroup]="form">
  <fieldset class="border border-1 rounded-1 p-3">
    <div class="row">
      <div class="col-md-4 col-sm-12 mb-4 position-relative">
        <label class="form-label" asteriskIfRequired=""
               [control]="searchControl"
               for="searchControl">{{lang.map.search_by_serial_number}}</label>
        <div validationClasses="" [control]="searchControl" class="input-group">
          <input (keydown.enter)="isSearchAllowed() && searchForLicense()" id="searchControl" validationClasses=""
                 [control]="searchControl" [formControl]="searchControl" class="form-control">
          <button *ngIf="isSearchAllowed()" (click)="searchForLicense()" class="input-group-text">
            <i class="mdi mdi-magnify text-primary"></i>
          </button>
        </div>
        <app-field-error-message [control]="searchControl"></app-field-error-message>
      </div>
      <div class="col-md-4 col-sm-12 mb-4 position-relative">
        <label class="form-label" asteriskIfRequired="oldLicenseFullSerial"
               for="oldLicenseFullSerial">{{lang.map.serial_number}}</label>
        <input id="oldLicenseFullSerial" validationClasses="oldLicenseFullSerial" formControlName="oldLicenseFullSerial"
               class="form-control" [readonly]="(isCancelRequestType() || readOnly || viewOnly)">
        <app-field-error-message controlName="oldLicenseFullSerial"></app-field-error-message>
      </div>
      <div class="col-md-4 col-sm-12 mb-4 position-relative">
        <label class="form-label" asteriskIfRequired="identificationNumber"
               for="identificationNumber">{{lang.map.identification_number}}</label>
        <input id="identificationNumber" validationClasses="identificationNumber" formControlName="identificationNumber"
               class="form-control" [readonly]="(isCancelRequestType() || readOnly || viewOnly)">
        <app-field-error-message controlName="identificationNumber"></app-field-error-message>
      </div>
    </div>
    <div class="row">
      <div class="col-sm-12 col-md-4">
        <div class="row">
          <div class="col-sm-12 mb-4 position-relative">
            <label class="form-label" asteriskIfRequired="locationDetails"
                   for="locationDetails">{{lang.map.location_details}}</label>
            <input id="locationDetails" validationClasses="locationDetails" formControlName="locationDetails"
                   class="form-control" [readonly]="(isCancelRequestType() || readOnly || viewOnly)">
            <app-field-error-message controlName="locationDetails"></app-field-error-message>
          </div>
          <div class="col-sm-12 mb-4 position-relative" *ngIf="isTemporaryLicenseDuration()">
            <label for="licenseEndDate" asteriskIfRequired="licenseEndDate"
                   class="form-label">{{lang.map.license_end_date}}</label>
            <div class="input-group">
              <i class="input-group-text mdi mdi-calendar"></i>
              <div class="form-control" formControlName="licenseEndDate"
                   id="licenseEndDate" [options]="datepickerOptionsMap.licenseEndDate"
                   [ngClass]="{'input-disabled': isEditLicenseEndDateDisabled()}"
                   (click)="!isEditLicenseEndDateDisabled() && dpLicenseEndDate.toggleCalendar()"
                   #dpLicenseEndDate="angular-mydatepicker" angular-mydatepicker
                   validationClasses="licenseEndDate"></div>
              <app-field-error-message controlName="licenseEndDate"></app-field-error-message>
            </div>
          </div>
          <div class="col-sm-12 mb-4 position-relative">
            <label class="form-label" asteriskIfRequired="latitude"
                   for="latitude">{{lang.map.latitude}} / {{lang.map.longitude}}</label>
            <div class="input-group">
              <input id="latitude" validationClasses="latitude" formControlName="latitude" class="form-control">
              <button type="button" (click)="openMapMarker()" class="input-group-text">
                <i class="mdi mdi-map-marker text-primary"></i>
              </button>
              <input id="longitude" validationClasses="longitude" formControlName="longitude" class="form-control">
            </div>
            <app-field-error-message controlName="latitude"></app-field-error-message>
          </div>
        </div>
      </div>
      <div class="col-sm-12 col-md-4 mb-4">
        <building-plate #buildingPlate [record]="item" [readOnly]="(isCancelRequestType() || readOnly || viewOnly)"
                        [propertyMap]="{buildingNo: 'buildingNumber', street:'streetNumber', zone: 'zoneNumber', unit: 'unitNumber'}"></building-plate>
      </div>
    </div>
    <div class="row">
      <div class="d-flex align-items-center justify-content-center gap-2">
        <button (click)="save$.next(null)" *ngIf="!readOnly && !viewOnly"
                class="btn btn-primary">{{editIndex ? lang.map.btn_save : lang.map.btn_add}}</button>
        <button (click)="cancel()" class="btn btn-secondary">{{lang.map.btn_cancel}}</button>
      </div>
    </div>
  </fieldset>
</form>
<div class="row mt-2">
  <app-table #table attachmentHandler [columns]="columns" [data]="model.collectionItemList">
    <table cdk-table [dataSource]="table.dataSource" class="table border border-1">
      <ng-container cdkColumnDef="identificationNumber">
        <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.identification_number}}</th>
        <td cdk-cell *cdkCellDef="let row"> {{row.identificationNumber}} </td>
      </ng-container>
      <ng-container cdkColumnDef="zoneNumber">
        <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.lbl_zone}}</th>
        <td cdk-cell *cdkCellDef="let row"> {{row.zoneNumber}} </td>
      </ng-container>
      <ng-container cdkColumnDef="streetNumber">
        <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.lbl_street}}</th>
        <td cdk-cell *cdkCellDef="let row"> {{row.streetNumber}} </td>
      </ng-container>
      <ng-container cdkColumnDef="buildingNumber">
        <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.building_number}}</th>
        <td cdk-cell *cdkCellDef="let row"> {{row.buildingNumber}} </td>
      </ng-container>
      <ng-container cdkColumnDef="unitNumber">
        <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.unit}}</th>
        <td cdk-cell *cdkCellDef="let row"> {{row.unitNumber}} </td>
      </ng-container>
      <ng-container cdkColumnDef="licenseEndDate">
        <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.license_end_date}}</th>
        <td cdk-cell *cdkCellDef="let row"> {{row.licenseEndDate|date: 'yyyy-MM-dd'}} </td>
      </ng-container>
      <ng-container cdkColumnDef="map">
        <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.item_location}}</th>
        <td cdk-cell *cdkCellDef="let row">
          <button (click)="openLocationMap(row)" [tooltip]="lang.map.show_location_on_map" class="btn icon-btn"><i
                  class="mdi mdi-map-marker text-primary"></i>
          </button>
        </td>
      </ng-container>
      <ng-container cdkColumnDef="approval_info_status">
        <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.lbl_status}}</th>
        <td cdk-cell *cdkCellDef="let row; index as itemIndex">
          <div *ngIf="approvalMode" class="d-flex">
            <i *ngIf="!row.hasValidApprovalInfo()" [tooltip]="lang.map.missing_approval_info"
               class="mdi mdi-alert-circle text-warning"></i>
            <i *ngIf="row.hasValidApprovalInfo()" [tooltip]="lang.map.approval_information_filled_out"
               class="mdi mdi-check-circle text-success"></i>
          </div>
        </td>
      </ng-container>
      <ng-container cdkColumnDef="oldLicenseFullSerial">
        <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.serial_number}}</th>
        <td cdk-cell *cdkCellDef="let row">
          <span *ngIf="isNewRequestType()">N/A</span>
          <span *ngIf="!isNewRequestType()" class="text-primary text-decoration-none cursor-pointer"
                (click)="viewOldLicense(row)">{{row.oldLicenseFullSerial || ''}}</span>
        </td>
      </ng-container>
      <ng-container cdkColumnDef="exportedLicenseFullSerial">
        <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.generated_license_number}}</th>
        <td cdk-cell *cdkCellDef="let row">
          <span class="text-primary text-decoration-none cursor-pointer"
                (click)="viewGeneratedLicense(row)">{{row.exportedLicenseFullSerial || ''}}</span>
        </td>
      </ng-container>
      <ng-container cdkColumnDef="actions">
        <th cdk-header-cell *cdkHeaderCellDef> {{lang.map.lbl_actions}}</th>
        <td cdk-cell *cdkCellDef="let row; index as itemIndex" class="table-actions">
          <grid-actions [record]="row" [actions]="actions" [itemIndex]="itemIndex">
            <button multiAttachment [formObservables]="formProperties" [model]="model" [item]="row"
                    identifier="collectionItemList" tooltip="{{lang.map.attachments}}"
                    class="btn text-primary icon-btn">
              <i class="mdi mdi-attachment"></i>
            </button>
          </grid-actions>
        </td>
      </ng-container>
      <tr cdk-header-row class="table-row-header" *cdkHeaderRowDef="table.columns"></tr>
      <tr cdk-row *cdkRowDef="let row; columns: table.columns;"></tr>
      <tr *cdkNoDataRow>
        <td colspan="100" class="text-center">{{lang.map.no_records_to_display}}</td>
      </tr>
    </table>
  </app-table>
</div>
